<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Horas</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2c2c2c">

<style>
body { font-family: Arial; background:#f2f2f2; padding:10px }
header { display:flex; justify-content:space-between; align-items:center }
.day { background:#fff; margin:8px 0; padding:10px; border-radius:8px }
button { margin:4px 4px 0 0; padding:6px 10px }
.small { font-size:13px; color:#444 }
</style>
</head>

<body>

<header>
  <button onclick="cambiarMes(-1)">◀</button>
  <h2 id="tituloMes"></h2>
  <button onclick="cambiarMes(1)">▶</button>
</header>

<div id="dias"></div>

<script>
// registrar service worker
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

// permiso notificaciones
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

let mes = new Date().getMonth();
let anio = new Date().getFullYear();
let notifInterval = null;
let notifActual = null;

function keyMes() {
  return `horas-${anio}-${mes}`;
}

function cargarMes() {
  const cont = document.getElementById("dias");
  cont.innerHTML = "";

  const data = JSON.parse(localStorage.getItem(keyMes())) || {};
  const ultimoDia = new Date(anio, mes + 1, 0).getDate();

  document.getElementById("tituloMes").innerText =
    new Date(anio, mes).toLocaleString("es", { month:"long", year:"numeric" });

  for (let d = 1; d <= ultimoDia; d++) {
    const fecha = new Date(anio, mes, d);
    const diaSemana = fecha.getDay();
    const r = data[d] || {};

    const div = document.createElement("div");
    div.className = "day";
    div.innerHTML = `
      <b>${d} - ${fecha.toLocaleDateString("es",{weekday:"long"})}</b><br>
      <span class="small">Entrada: ${r.inicio || "-"}</span><br>
      <span class="small">Salida: ${r.fin || "-"}</span><br>
      <span class="small">Horas del día: ${r.total || "0"} hs</span><br>
      <span class="small">Normales: ${(r.normales||0).toFixed(2)} hs</span><br>
      <span class="small">Extra 50%: ${(r.e50||0).toFixed(2)} hs</span><br>
      <span class="small">Extra 100%: ${(r.e100||0).toFixed(2)} hs</span><br>
      <button onclick="iniciar(${d})">Iniciar</button>
      <button onclick="finalizar(${d}, ${diaSemana})">Finalizar</button>
    `;
    cont.appendChild(div);
  }
}

function iniciarNotificacion(inicioTS) {
  if (!("Notification" in window)) return;
  if (Notification.permission !== "granted") return;

  notifInterval = setInterval(() => {
    const horas = (Date.now() - inicioTS) / 3600000;
    const h = Math.floor(horas);
    const m = Math.floor((horas - h) * 60);

    if (notifActual) notifActual.close();
    notifActual = new Notification("⏱ Registro de horas", {
      body: `Llevás ${h} h ${m} min`,
      silent: true
    });
  }, 60000);
}

function iniciar(dia) {
  const ahora = new Date();
  let data = JSON.parse(localStorage.getItem(keyMes())) || {};
  if (!data[dia]) data[dia] = {};

  data[dia].inicio = ahora.toLocaleTimeString("es",{hour:'2-digit',minute:'2-digit'});
  data[dia].inicioTS = ahora.getTime();

  localStorage.setItem(keyMes(), JSON.stringify(data));
  iniciarNotificacion(data[dia].inicioTS);
  cargarMes();
}

function finalizar(dia, diaSemana) {
  let data = JSON.parse(localStorage.getItem(keyMes())) || {};
  if (!data[dia] || !data[dia].inicioTS) {
    alert("No iniciaste el día");
    return;
  }

  const inicio = new Date(data[dia].inicioTS);
  const fin = new Date();
  const horas = (fin - inicio) / 3600000;
  const horaFin = fin.getHours() + fin.getMinutes() / 60;

  data[dia].fin = fin.toLocaleTimeString("es",{hour:'2-digit',minute:'2-digit'});
  data[dia].total = horas.toFixed(2);

  data[dia].normales = 0;
  data[dia].e50 = 0;
  data[dia].e100 = 0;

  // DOMINGO
  if (diaSemana === 0) {
    data[dia].e100 = horas;
  }
  // SÁBADO
  else if (diaSemana === 6) {
    const normales = Math.min(5, horas);
    const extra = Math.max(0, horas - 5);

    data[dia].normales = normales;

    if (extra > 0) {
      if (horaFin >= 13) data[dia].e100 = extra;
      else data[dia].e50 = extra;
    }
  }
  // LUNES A VIERNES
  else {
    const normales = Math.min(8, horas);
    const extra = Math.max(0, horas - 8);

    data[dia].normales = normales;
    data[dia].e50 = extra;
  }

  localStorage.setItem(keyMes(), JSON.stringify(data));

  if (notifInterval) clearInterval(notifInterval);
  if (notifActual) notifActual.close();

  cargarMes();
}

function cambiarMes(dir) {
  mes += dir;
  if (mes < 0) { mes = 11; anio--; }
  if (mes > 11) { mes = 0; anio++; }
  cargarMes();
}

cargarMes();
</script>

</body>
  </html>
